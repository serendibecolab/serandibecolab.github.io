---
import YukinaConfig from "../../yukina.config";
import { Image } from "astro:assets";

export interface Props {
  title?: string;
  subTitle?: string;
  slug?: string;
  coverImage?: {
    src: string;
    alt: string;
  };
}
const { title, subTitle, slug, coverImage } = Astro.props;

const hasTitle = title !== undefined || subTitle !== undefined;

let carouselImgsList = YukinaConfig.banners;
const carouselAnimationTime = `${carouselImgsList.length * 10}s`;
---

<div id="banner" class="banner relative z-10" { ...coverImage ? {} : { 'data-banner-config': JSON.stringify(carouselImgsList) } }>
  <div class="transition-main banner-inner h-full w-full">
    {coverImage ? (
      <div class="carousel">
        <Image
          src={coverImage.src}
          alt={coverImage.alt}
          width={1920}
          height={1080}
          class="absolute inset-0 h-full w-full object-cover"
        />
      </div>
    ) : (
      <div class="carousel">
        <ul id="carousel_imgs">
          {carouselImgsList.map((img, index) => (
            <li
              class="item"
              style={{
                animationDelay: `${index * 10}s`,
              }}
            >
              <Image
                src={img.src}
                alt={`Banner image ${index + 1}`}
                width={1920}
                height={1080}
                class="absolute inset-0 h-full w-full object-cover"
                style={{ objectPosition: img.focalPoint }}
              />
            </li>
          ))}
        </ul>
      </div>
    )}

    <div class="relative h-[95%] w-full">
      <!-- Centered title/subtitle -->
      <div
        class="absolute left-1/2 top-1/2 w-4/5 -translate-x-1/2 -translate-y-1/2 lg:w-3/4"
      >
        <div class="flex flex-col items-center text-center">
          <h1
            class:list={[hasTitle ? "title-normal" : "title-index"]}
            class="title"
          >
            {title ?? YukinaConfig.title}
          </h1>
          <h2 class="subtitle">{subTitle ?? YukinaConfig.subTitle}</h2>
        </div>
      </div>

      <!-- Dynamic text bottom-left -->
      { !coverImage && (
        <div
          id="dynamic-banner-text"
          class="absolute bottom-8 left-8 z-20 max-w-[80%] p-4 text-left drop-shadow-md font-[var(--subtitle-font)] leading-tight"
        >
          <!-- Dynamic text inserted here -->
        </div>
      )}
    </div>
  </div>

  <!-- Scroll indicator -->
  <div class="scroll-indicator">
    <svg
      class="w-6 h-6 text-white"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M19 14l-7 7m0 0l-7-7m7 7V3"
      ></path>
    </svg>
    <span class="text-white text-sm mt-2">Scroll Down</span>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const bannerElement = document.getElementById("banner");
    const isCoverImagePresent = bannerElement?.dataset.bannerConfig === undefined;

    if (isCoverImagePresent) {
      // If a cover image is present, no carousel or dynamic text logic is needed.
      return;
    }

    const styleElement = document.createElement("style");
    const carouselImgs = document.getElementById("carousel_imgs");
    const carouselImgsCount = carouselImgs?.children.length ?? 0;
    const carouselAnimationTime = `${carouselImgsCount * 15}s`;

    const carouselAnimation = `
      @keyframes carousel-animation {
        0% { opacity: 0; transform: scale(1); }
        3% { opacity: 1; }
        8% { opacity: 1; animation-timing-function: ease-out; }
        ${100 / carouselImgsCount}% { opacity: 1; }
        ${100 / carouselImgsCount + 50 / carouselImgsCount}% { opacity: 0; transform: scale(2); }
        100% { opacity: 0; transform: scale(2); }
      }
    `;

    styleElement.textContent = carouselAnimation;
    if (bannerElement && !bannerElement.querySelector("style"))
      bannerElement.appendChild(styleElement);

    if (carouselImgs) {
      Array.from(carouselImgs.children).forEach((item, index) => {
        item.style.animationDuration = carouselAnimationTime;
        item.style.animationDelay = `${index * 10}s`;
      });
    }

    // Dynamic Text Logic
    const dynamicBannerTextDiv = document.getElementById("dynamic-banner-text");
    const bannerConfigData = bannerElement?.dataset.bannerConfig;
    let carouselImgsList = [];

    if (bannerConfigData) {
      try {
        carouselImgsList = JSON.parse(bannerConfigData);
      } catch (e) {
        console.error("Failed to parse banner config data:", e);
      }
    }

    const imageDisplayInterval = 10 * 1000;

    function updateTextContent(index) {
      if (!dynamicBannerTextDiv || !carouselImgsList.length) return;

      dynamicBannerTextDiv.style.opacity = "0";
      setTimeout(() => {
        dynamicBannerTextDiv.innerHTML = "";
        const currentImage = carouselImgsList[index];
        if (currentImage && currentImage.textLines) {
          currentImage.textLines.forEach((line, lineIndex) => {
            const p = document.createElement("p");
            p.textContent = line;
            p.style.fontSize = lineIndex === 0
              ? "clamp(1rem, 2.5vw, 2rem)"
              : "clamp(0.9rem, 2vw, 1.6rem)";
            p.style.color = "#ffffff"; // Dynamic text in white
            dynamicBannerTextDiv.appendChild(p);
          });
        }
        dynamicBannerTextDiv.style.opacity = "1";
      }, 50);
    }

    function scheduleTextUpdates() {
      carouselImgsList.forEach((_, index) => {
        const imageAnimationStartTime = index * imageDisplayInterval;
        setTimeout(() => updateTextContent(index), imageAnimationStartTime);
      });
    }

    scheduleTextUpdates();
    const totalLoopDuration = carouselImgsList.length * imageDisplayInterval;
    setInterval(scheduleTextUpdates, totalLoopDuration);
  });
</script>

<style define:vars={{ carouselAnimationTime }}>
  .banner {
    @apply relative h-screen opacity-100;
  }

  .carousel {
    @apply absolute left-0 top-0 -z-10 block h-screen w-full overflow-hidden bg-[var(--background-color)];
    animation-fill-mode: forwards;
  }

  .carousel::before {
    @apply absolute left-0 top-0 z-10 block h-full w-full bg-black/25 transition-all content-[''];
    @apply dark:bg-black/30;
  }

  .carousel .item {
    @apply absolute left-0 top-0 z-0 h-full w-full origin-center opacity-0; /* Removed bg-cover, bg-center, bg-no-repeat */
    animation: carousel-animation var(--carouselAnimationTime) linear infinite 0s;
    backface-visibility: hidden;
    transform-style: preserve-3d;
  }

  .title {
    color: var(--title-color);
    font-family: var(--title-font);
    font-weight: 700;
    text-shadow: 0 2px 6px rgba(0,0,0,0.4);
    line-height: 1.1;
    text-align: center;
    font-size: clamp(2rem, 6vw, 5rem);
  }

  .subtitle {
    color: var(--subtitle-color);
    font-family: var(--subtitle-font);
    text-align: center;
    font-weight: 400;
    line-height: 1.2;
    font-size: clamp(1rem, 3vw, 2.5rem);
    text-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }

  #dynamic-banner-text {
    font-size: clamp(0.9rem, 2.5vw, 1.8rem);
    position: absolute;
    bottom: 2rem;
    left: 2rem;
    text-align: left;
    transition: opacity 0.3s ease-in-out;
    z-index: 20;
    color: #ffffff;
    text-shadow: 0 2px 6px rgba(0,0,0,0.6);
  }

  .scroll-indicator {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 20;
    animation: bounce 2s infinite;
  }

  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
      transform: translateX(-50%) translateY(0);
    }
    40% { transform: translateX(-50%) translateY(-10px); }
    60% { transform: translateX(-50%) translateY(-5px); }
  }
</style>